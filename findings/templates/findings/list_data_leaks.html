{% extends "base.html" %}
{% load static %}

{% block header %}
<style>
#table_list_findings tbody tr.selected td {background-color:#B0BED9}
#table_list_findings tbody tr.odd.selected td {background-color:#acbad4}
</style>
{% endblock %}

{% block content %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
        </div>
        <div class="media-body">
            <h2 class="media-heading">ðŸ’§ Data Leaks</h2>
        </div>
    </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}

<form id="form-selected-findings" action="" method="POST">
  {% csrf_token %}

<div class="container-fluid" style="padding-left:0; padding-right:0;">
  <div class="row">
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">// Selected Actions</div>
                <div class="panel-body">
                    <button type="submit" name="btnignore" id="toggle-ignore-selected-findings" class="btn btn-primary btn-xs">Toggle ignore status for selected</button>&nbsp;
                    <button type="submit" name="btndelete" id="delete-selected-findings" class="btn btn-primary btn-xs confirm">Delete selected</button>&nbsp;
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Findings List Tabs -->
<div class="panel panel-default">
  <div class="panel-heading">
    // Monitored Findings
  </div>
  <div class="panel-body table-responsive">
        <div class="form-group" style="margin-bottom:10px;">
            <label for="selection-filter">Monitored Findings:</label>
            <select id="selection-filter" class="form-control input-sm" style="width:auto; display:inline-block;">
                <option value="monitored" selected>Monitored</option>
                <option value="ignored">Ignored</option>
                <option value="all">All</option>
            </select>
        </div>
    <table id="table_list_findings" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
      <thead>
      <tr>
          <th><input type="checkbox" name="select_all" value="1" id="select-all-findings">&nbsp; Operations</th>
          <!-- <th>Domain Name</th> -->
          <th>Keyword</th>
          <th>Source</th>
          <th>Name</th>
          <th>Description</th>
          <th>URL</th>
          <th>Scan Date</th>
          <th>Comment</th>
        </tr>
      <tr>
          <th></th>
          <!-- <th><input type="text" placeholder="Search Domain Name" class="column-search form-control input-sm"></th> -->
          <th><input type="text" placeholder="Search Keyword" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Source" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Name" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Description" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search URL" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Scan Date" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Comment" class="column-search form-control input-sm"></th>
        </tr>
      </thead>
    </table>
  </div>
</div>

</form>

<!-- Modal for editing comments -->
<div class="modal fade" id="editCommentModal" tabindex="-1" role="dialog" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">Edit Comment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <div class="form-group">
                        <label for="commentText">Comment</label>
                        <textarea class="form-control" id="commentText" rows="3" placeholder="Enter your comment here..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveCommentButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endspaceless %}
{% endblock %}

{% block javascript %}
<script src="{% static 'js/bootbox.min.js' %}"></script>
<script type="text/javascript" language="javascript" class="init">

// Populate Datatables
$(document).ready( function () {
    // Monitored findings
    var findingsTable = $('#table_list_findings').DataTable({
        processing: true, serverSide: true, pageLength: 25,
        orderCellsTop: false,
        oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
        order: [[ 1, "asc" ]],
        ajax: {
            processing: true,
            url: "/api/v1/project/{{ projectid }}/findings/data_leaks/",
            dataSrc: "results",
            type: "GET",
            dataType: "json",
            data: function (d) {
                var selectionFilter = $('#selection-filter').val();
                if (selectionFilter !== undefined && selectionFilter !== "") {
                    d.selection = selectionFilter;
                }
            }
        },
        columns: [
            {'data': 'id', 'sName': 'Operations', 'aTargets': [ 0 ],
                'bSortable': false,
                "mRender": function (data, type, full) {
                    var ignore_url = "{% url 'findings:ignore_finding_glyphicon' findingid=0 %}"
                        .replace('ignore/0', 'ignore/' + full.id);
                    var delete_url = "{% url 'api:delete_finding' projectid=0 findingid=0 %}"
                        .replace('project/0', 'project/{{ projectid }}')
                        .replace('delete/0', 'delete/' + full.id);
                    return '<div class="btn-group1">' +
                        '<input type="checkbox" name="id[]" value="' + $('<div/>').text(data).html() + '">&nbsp;&nbsp;' +
                        '<a class="btn btn-xs toggle-ignore-finding" rel="tooltip" data-placement="right" data-original-title="Toggle ignore status" data-display="' + full.name + '" href="' + ignore_url + '">' +
                            '<span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>' +
                        '</a> ' +
                        '<a class="btn btn-xs confirm" rel="tooltip" data-placement="right" data-original-title="Delete Entry" data-display="' + full.name + '" data-href="' + delete_url + '" href="#" data-method="DELETE">' +
                            '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                        '</a>' +
                        '<a class="btn btn-xs edit-comment" rel="tooltip" data-placement="right" data-original-title="Edit Comment" data-display="' + full.name + '" href="#" data-id="' + full.id + '">' +
                            '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>' +
                        '</a>' +
                        '</div>';
                },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("a", nTd).tooltip();
                }
            },
            // {'data': 'domain_name', 'sName': 'Domain Name', 'aTargets': [ 1 ],
            //     "mRender": function (data, type, full) {
            //         var select_url = "{% url 'findings:view_asset' uuid=0 %}".replace(0, full.domain);
            //         return '<div rel="tooltip" data-placement="left" data-original-title="Show details"><a href="'+select_url+'">'+data+'</a></div>';
            //     },
            //     "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
            //         $("div", nTd).tooltip();
            //     },
            // },
            {'data': 'keyword', 'sName': 'Keyword', 'aTargets': [ 1 ], 'bSortable': true},
            {'data': 'source', 'sName': 'Source', 'aTargets': [ 2 ], 'bSortable': true},
            {'data': 'name', 'sName': 'Name', 'aTargets': [ 3 ], 'bSortable': true},
            {'data': 'description', 'sName': 'Description', 'aTargets': [ 4 ], 'bSortable': true},
            {'data': 'url', 'sName': 'URL', 'aTargets': [ 5 ], 'bSortable': true,
                'mRender': function (data, type, full) {
                    if (!data) return '';
                    return '<a href="' + $('<div/>').text(data).html() + '" target="_blank">' + $('<div/>').text(data).html() + '</a>';
                }
            },
            {'data': 'scan_date', 'sName': 'Scan Date', 'aTargets': [ 6 ], 'bSortable': true,
                'render': function(data, type, row) {
                if (!data) return '';
                if (window.moment) {
                    return moment(data).format('DD-MM-YYYY HH:mm');
                }
                return data;
                }
            },
            {'data': 'comment', 'sName': 'Comment', 'aTargets': [ 7 ], 'bSortable': true},
        ]
    });

    // Apply the search
    // Use the global debounced column search from base.html
    applyDebouncedColumnSearch(findingsTable, 'input.column-search', 'select.column-search');

    // Apply the severity filter (if it exists)
    $('#severity-filter').on('change', function () {
        let selectedSeverity = $(this).val();
        // Find the severity column index dynamically
        let severityColumnIndex = findingsTable.column(':contains("Severity")').index();
        if (severityColumnIndex !== -1) {
            findingsTable.column(severityColumnIndex).search(selectedSeverity).draw();
        }
    });

    // Server-side selection filter
    $('#selection-filter').on('change', function () {
        findingsTable.ajax.reload();
    });

    // Initialize all common DataTable features
    initializeCommonDataTableFeatures(findingsTable, {
        enableBulkIgnore: true,
        hasNucleus: false,
        hasCommentModal: true,
        projectId: "{{ projectid }}",
        selectAllId: '#select-all-findings',
        tableId: '#table_list_findings'
    });

    // Note: All common functionality (checkboxes, ignore, delete, comments) is now handled by common-datatable.js

});

</script>
{% endblock %}