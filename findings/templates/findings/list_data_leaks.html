{% extends "base.html" %}
{% load static %}

{% block header %}
<style>
#table_list_findings tbody tr.selected td {background-color:#B0BED9}
#table_list_findings tbody tr.odd.selected td {background-color:#acbad4}
</style>
{% endblock %}

{% block content %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
        </div>
        <div class="media-body">
            <h2 class="media-heading">Data leaks</h2>Data leaks ...
        </div>
    </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}

<form id="form-selected-findings" action="" method="POST">
  {% csrf_token %}

<div class="container-fluid" style="padding-left:0; padding-right:0;">
  <div class="row">
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">// Selected Actions</div>
                <div class="panel-body">
                    <button type="submit" name="btnignore" id="toggle-ignore-selected-findings" class="btn btn-primary btn-xs">Toggle ignore status for selected</button>&nbsp;
                    <button type="submit" name="btndelete" id="delete-selected-findings" class="btn btn-primary btn-xs confirm">Delete selected</button>&nbsp;
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Findings List Tabs -->
<div class="panel panel-default">
  <div class="panel-heading">
    // Monitored Findings
  </div>
  <div class="panel-body table-responsive">
        <div class="form-group" style="margin-bottom:10px;">
            <label for="selection-filter">Monitored Findings:</label>
            <select id="selection-filter" class="form-control input-sm" style="width:auto; display:inline-block;">
                <option value="monitored" selected>Monitored</option>
                <option value="ignored">Ignored</option>
                <option value="all">All</option>
            </select>
        </div>
    <table id="table_list_findings" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
      <thead>
      <tr>
          <th><input type="checkbox" name="select_all" value="1" id="select-all-findings">&nbsp; Operations</th>
          <!-- <th>Domain Name</th> -->
          <th>Keyword</th>
          <th>Source</th>
          <th>Name</th>
          <th>Description</th>
          <th>URL</th>
          <th>Scan Date</th>
        </tr>
      <tr>
          <th></th>
          <!-- <th><input type="text" placeholder="Search Domain Name" class="column-search form-control input-sm"></th> -->
          <th><input type="text" placeholder="Search Keyword" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Source" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Name" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Description" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search URL" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Scan Date" class="column-search form-control input-sm"></th>
        </tr>
      </thead>
    </table>
  </div>
</div>

</form> <!-- close selection form -->

{% endspaceless %}
{% endblock %}

{% block javascript %}
<script src="{% static 'js/bootbox.min.js' %}"></script>
<script type="text/javascript" language="javascript" class="init">

// Populate Datatables
$(document).ready( function () {
    // Monitored findings
    var findingsTable = $('#table_list_findings').DataTable({
        processing: true, serverSide: true, pageLength: 25,
        orderCellsTop: true,
        oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
        order: [[ 1, "asc" ]],
        ajax: {
            processing: true,
            url: "/api/v1/project/{{ projectid }}/findings/data_leaks/",
            dataSrc: "results",
            type: "GET",
            dataType: "json",
            data: function (d) {
                var selectionFilter = $('#selection-filter').val();
                if (selectionFilter !== undefined && selectionFilter !== "") {
                    d.selection = selectionFilter;
                }
            }
        },
        columns: [
            {'data': 'id', 'sName': 'Operations', 'aTargets': [ 0 ],
                'bSortable': false,
                "mRender": function (data, type, full) {
                    var ignore_url = "{% url 'findings:ignore_finding_glyphicon' findingid=0 %}"
                        .replace('ignore/0', 'ignore/' + full.id);
                    var delete_url = "{% url 'api:delete_finding' projectid=0 findingid=0 %}"
                        .replace('project/0', 'project/{{ projectid }}')
                        .replace('delete/0', 'delete/' + full.id);
                    return '<div class="btn-group1">' +
                        '<input type="checkbox" name="id[]" value="' + $('<div/>').text(data).html() + '">&nbsp;&nbsp;' +
                        '<a class="btn btn-xs toggle-ignore-finding" rel="tooltip" data-placement="right" data-original-title="Toggle ignore status" data-display="' + full.name + '" href="' + ignore_url + '">' +
                            '<span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>' +
                        '</a> ' +
                        '<a class="btn btn-xs confirm" rel="tooltip" data-placement="right" data-original-title="Delete Entry" data-display="' + full.name + '" data-href="' + delete_url + '" href="#" data-method="DELETE">' +
                            '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                        '</a>' +
                        '</div>';
                },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("a", nTd).tooltip();
                }
            },
            // {'data': 'domain_name', 'sName': 'Domain Name', 'aTargets': [ 1 ],
            //     "mRender": function (data, type, full) {
            //         var select_url = "{% url 'findings:view_asset' uuid=0 %}".replace(0, full.domain);
            //         return '<div rel="tooltip" data-placement="left" data-original-title="Show details"><a href="'+select_url+'">'+data+'</a></div>';
            //     },
            //     "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
            //         $("div", nTd).tooltip();
            //     },
            // },
            {'data': 'keyword', 'sName': 'Keyword', 'aTargets': [ 2 ]},
            {'data': 'source', 'sName': 'Source', 'aTargets': [ 3 ]},
            {'data': 'name', 'sName': 'Name', 'aTargets': [ 4 ]},
            {'data': 'description', 'sName': 'Description', 'aTargets': [ 5 ]},
            {'data': 'url', 'sName': 'URL', 'aTargets': [ 6 ],
                'mRender': function (data, type, full) {
                    if (!data) return '';
                    return '<a href="' + $('<div/>').text(data).html() + '" target="_blank">' + $('<div/>').text(data).html() + '</a>';
                }
            },
            {'data': 'scan_date', 'sName': 'Scan Date', 'aTargets': [ 7 ],
                'render': function(data, type, row) {
                if (!data) return '';
                if (window.moment) {
                    return moment(data).format('DD-MM-YYYY HH:mm');
                }
                return data;
                }
            },
        ]
    });

    // Apply the search
    // Use the global debounced column search from base.html
    applyDebouncedColumnSearch(findingsTable, 'input.column-search', 'select.column-search');

    // Apply the severity filter
    $('#severity-filter').on('change', function () {
        let selectedSeverity = $(this).val();
        findingsTable.column(6).search(selectedSeverity).draw();
    });

    // Server-side selection filter
    $('#selection-filter').on('change', function () {
        findingsTable.ajax.reload();
    });

    // checkbox stuff
    // Handle click on "Select all" control
    $('#select-all-findings').on('click', function(){
        // Get all rows with search applied
        var rows = findingsTable.rows({ 'search': 'applied' }).nodes();
        // Check/uncheck checkboxes for all rows in the table
        $('input[type="checkbox"]', rows).prop('checked', this.checked);
    });
    // Handle click on checkbox to set state of "Select all" control
    $('#table_list_findings tbody').on('change', 'input[type="checkbox"]', function(){
        // If checkbox is not checked
        if(!this.checked){
            var el = $('#select-all-findings').get(0);
            // If "Select all" control is checked and has 'indeterminate' property
            if(el && el.checked && ('indeterminate' in el)){
                // Set visual state of "Select all" control
                // as 'indeterminate'
                el.indeterminate = true;
                }
            }
    });
    // submit
    $('#form-selected-findings').on('submit', function(e){
        var form = this;
        findingsTable.$('input[type="checkbox"]').each(function(){
            if(!$.contains(document, this)){
                if(this.checked){
                    $(form).append(
                        $('<input>')
                        .attr('type', 'hidden')
                        .attr('name', this.name)
                        .val(this.value)
                    );
                }
            } 
        });
    });

    // Simple AJAX toggle ignore status (single row)
    $(document).on("click", ".toggle-ignore-finding", function(e) {
        e.preventDefault();
        var url = $(this).attr('href');
        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                displayMessage('info', 'Ignore status toggled.');
                findingsTable.ajax.reload();
            },
            error: function(xhr) {
                displayMessage('danger', 'Toggle failed');
            }
        });
    });

    // Simple AJAX toggle ignore status for selected (bulk)
    $('#toggle-ignore-selected-findings').on('click', function(e) {
        e.preventDefault();
        var checked = $('#table_list_findings input[type="checkbox"][name="id[]"]:checked');
        if (checked.length === 0) {
            displayMessage('warning', 'No findings selected.');
            return;
        }
        var total = checked.length;
        var done = 0;
        checked.each(function() {
            var findingId = $(this).val();
            var url = "{% url 'findings:ignore_finding_glyphicon' findingid=0 %}".replace('ignore/0', 'ignore/' + findingId);
            $.ajax({
                url: url,
                type: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                complete: function() {
                    done++;
                    if (done === total) {
                        displayMessage('info', 'Ignore status toggled for selected findings.');
                        findingsTable.ajax.reload();
                    }
                }
            });
        });
    });

    // confirm bootbox
    $(document).on("click", ".confirm", function(e) {
        e.preventDefault();
        var title = $(this).attr('data-display');
        var location = $(this).attr('data-href');
        var method = $(this).attr('data-method');
        var form = $(this).closest('form'); // Find the closest form element
        var buttonName = $(this).attr('name'); // Get the button's name attribute

        bootbox.confirm('Are you sure?', function(confirmed) {
            if (confirmed) {
                if (method && method.toUpperCase() === 'DELETE') {
                    // If data-method is DELETE, send DELETE request via AJAX
                    $.ajax({
                        url: location,
                        type: 'DELETE',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        success: function(response) {
                            displayMessage('info', 'Entry deleted successfully.');
                            // Optionally reload table or page
                            findingsTable.ajax.reload();
                        },
                        error: function(xhr) {
                            var error = xhr.responseText ? JSON.parse(xhr.responseText) : {error: 'Delete failed'};
                            displayMessage('danger', 'Error: ' + (error.error || 'Delete failed'));
                        }
                    });
                } else if (form.length) {
                    // If it's part of a form, append the action URL and button name, then submit the form
                    $('<input>')
                        .attr('type', 'hidden')
                        .attr('name', 'action_url')
                        .val(location)
                        .appendTo(form);
                    if (buttonName) {
                        $('<input>')
                            .attr('type', 'hidden')
                            .attr('name', buttonName)
                            .val('true')
                            .appendTo(form);
                    }
                    form.submit();
                } else {
                    // Otherwise, redirect as before
                    window.location.replace(location);
                }
            }
        });
    });

    // AJAX Send to nucleus
    $(document).on("click", ".send-to-nucleus", function (e) {
        e.preventDefault(); // Prevent the default link behavior
        displayMessage("info", "Sending the finding to Nucleus...");
    
        var url = $(this).data("url"); // Get the URL from the data-url attribute
        var title = $(this).data("display"); // Get the display name for feedback
    
        // Send the AJAX request
        $.ajax({
            url: url,
            type: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken") // Include CSRF token
            },
            success: function (response) {
                // Show success feedback
                displayMessage("info", "Finding sent to Nucleus successfully.");
            },
            error: function (xhr) {
                // Show error feedback
                var error = JSON.parse(xhr.responseText);
                displayMessage("danger", "Error: " + error.error);
            }
        });
    });
    
    // Helper function to display messages dynamically
    function displayMessage(type, message) {
        var alertDiv = $('<div>')
            .addClass('alert alert-' + type)
            .text(message);

        // Append the message to the top of the page or a specific container
        $('.page-header').after(alertDiv);

        // Automatically remove the message after 5 seconds
        setTimeout(function () {
            alertDiv.fadeOut(function () {
                $(this).remove();
            });
        }, 5000);
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

});

</script>
{% endblock %}