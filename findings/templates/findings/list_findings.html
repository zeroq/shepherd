{% extends "base.html" %}
{% load static %}

{% block header %}
<style>
#table_list_findings tbody tr.selected td {background-color:#B0BED9}
#table_list_findings tbody tr.odd.selected td {background-color:#acbad4}
</style>
{% endblock %}

{% block content %}
{% spaceless %}
<div class="page-header">
    <div class="media">
        <div class="media-left">
        </div>
        <div class="media-body">
            <h2 class="media-heading">üõ°Ô∏è Findings</h2>
        </div>
    </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}

<form id="form-selected-findings" action="" method="POST">
  {% csrf_token %}

<div class="container-fluid" style="padding-left:0; padding-right:0;">
  <div class="row">
    <div class="col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">// Selected Actions</div>
        <div class="panel-body">
          <button type="submit" name="btnignore" id="toggle-ignore-selected-findings" class="btn btn-primary btn-xs">Toggle ignore status for selected</button>&nbsp;
          <button type="submit" name="btndelete" id="delete-selected-findings" class="btn btn-primary btn-xs confirm">Delete selected</button>&nbsp;
          <button type="submit" name="btnreport" id="report-selected-findings" class="btn btn-primary btn-xs confirm">Report selected (Nucleus)</button>&nbsp;
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Findings List Tabs -->
<div class="panel panel-default">
  <div class="panel-heading">
    // Findings
  </div>
  <div class="panel-body table-responsive">
    <div class="form-group" style="margin-bottom:10px;">
            <label for="reported-filter">Reported Status:</label>
            <select id="reported-filter" class="form-control input-sm" style="width:auto; display:inline-block;">
                <option value="not_reported" selected>Not Reported</option>
                <option value="reported">Reported</option>
                <option value="">All</option>
            </select>
            &nbsp;&nbsp;
            <label for="monitored-filter">Monitored Status:</label>
            <select id="monitored-filter" class="form-control input-sm" style="width:auto; display:inline-block;">
                <option value="monitored" selected>Monitored</option>
                <option value="ignored">Ignored</option>
                <option value="all">All</option>
            </select>
    </div>
    <table id="table_list_findings" class="table table-condensed table-striped table-bordered findings-table" style="font-size: 0.9em;">
      <thead>
        <tr>
          <th><input type="checkbox" name="select_all" value="1" id="select-all-findings">&nbsp; Operations</th>
          <th>Domain Name</th>
          <th>Vulnerability Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Source</th>
          <th>Severity</th>
          <th>Scan Date</th>
          <th>Last Reported</th>
          <th>Comment</th>
        </tr>
        <tr>
          <th></th>
          <th><input type="text" placeholder="Search Domain Name" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Vulnerability Name" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Type" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Description" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Source" class="column-search form-control input-sm"></th>
          <th>
            <select id="severity-filter" class="form-control input-sm">
              <option value="">All Severities</option>
              <option value="info">Info</option>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </th>
          <th><input type="text" placeholder="Search Scan Date" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Last reported" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Comment" class="column-search form-control input-sm"></th>
        </tr>
      </thead>
    </table>
  </div>
</div>

</form> <!-- close selection form -->

<!-- Modal for editing comments -->
<div class="modal fade" id="editCommentModal" tabindex="-1" role="dialog" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">Edit Comment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <div class="form-group">
                        <label for="commentText">Comment</label>
                        <textarea class="form-control" id="commentText" rows="3" placeholder="Enter your comment here..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveCommentButton">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endspaceless %}
{% endblock %}

{% block javascript %}
<script src="{% static 'js/bootbox.min.js' %}"></script>
<script type="text/javascript" language="javascript" class="init">

// Populate Datatables
$(document).ready( function () {
    // Monitored findings
    var findingsTable = $('#table_list_findings').DataTable({
        processing: true, serverSide: true, pageLength: 25,
        orderCellsTop: true,
        oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
        order: [[ 1, "asc" ]],
        ajax: {
            processing: true,
            url: "/api/v1/project/{{ projectid }}/findings/all/",
            dataSrc: "results",
            type: "GET",
            dataType: "json",
            data: function (d) {
                var reportedFilter = $('#reported-filter').val();
                if (reportedFilter !== undefined && reportedFilter !== "") {
                    d.reported = reportedFilter;
                }
                var monitoredFilter = $('#monitored-filter').val();
                if (monitoredFilter !== undefined && monitoredFilter !== "") {
                    d.selection = monitoredFilter;
                }
                var severityFilter = $('#severity-filter').val();
                if (severityFilter !== undefined && severityFilter !== "") {
                    d.severity = severityFilter;
                }
            }
        },
        columns: [
            {'data': 'id', 'sName': 'Operations', 'aTargets': [ 0 ],
                'bSortable': false,
                "mRender": function (data, type, full) {
                    var ignore_url = "{% url 'findings:ignore_finding_glyphicon' findingid=0 %}"
                        .replace('ignore/0', 'ignore/' + full.id);
                    var delete_url = "{% url 'api:delete_finding' projectid=0 findingid=0 %}"
                        .replace('project/0', 'project/{{ projectid }}')
                        .replace('delete/0', 'delete/' + full.id);
                    var nucleus_url = "{% url 'findings:send_nucleus' findingid=0 %}"
                        .replace('nucleus/0', 'nucleus/' + full.id)
                    return '<div class="btn-group1">' +
                        '<input type="checkbox" name="id[]" value="' + $('<div/>').text(data).html() + '">&nbsp;&nbsp;' +
                        '<a class="btn btn-xs toggle-ignore-finding" rel="tooltip" data-placement="right" data-original-title="Toggle ignore status" data-display="' + full.name + '" href="' + ignore_url + '">' +
                            '<span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>' +
                        '</a> ' +
                        '<a class="btn btn-xs confirm" rel="tooltip" data-placement="right" data-original-title="Delete Entry" data-display="' + full.name + '" data-href="' + delete_url + '" href="#" data-method="DELETE">' +
                            '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>' +
                        '</a>' +
                        '<a class="btn btn-xs send-to-nucleus" rel="tooltip" data-placement="right" data-original-title="To Nucleus" data-display="' + full.name + '" data-url="' + nucleus_url + '" href="#">' +
                            '<span class="glyphicon glyphicon-send" aria-hidden="true"></span>' +
                        '</a> ' +
                        '<a class="btn btn-xs edit-comment" rel="tooltip" data-placement="right" data-original-title="Edit Comment" data-display="' + full.name + '" href="#" data-id="' + full.id + '">' +
                            '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>' +
                        '</a>' +
                        '</div>';
                },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("a", nTd).tooltip();
                }
            },
            {'data': 'domain_name', 'sName': 'Domain Name', 'aTargets': [ 1 ],
                "mRender": function (data, type, full) {
                    var select_url = "{% url 'findings:view_asset' uuid=0 %}".replace(0, full.domain);
                    return '<div rel="tooltip" data-placement="left" data-original-title="Show details"><a href="'+select_url+'">'+data+'</a></div>';
                },
                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                    $("div", nTd).tooltip();
                },
            },
            {'data': 'name', 'sName': 'Vulnerability Name', 'aTargets': [ 2 ]},
            {'data': 'type', 'sName': 'Type', 'aTargets': [ 3 ]},
            {'data': 'description', 'sName': 'Description', 'aTargets': [ 4 ]},
            {'data': 'source', 'sName': 'Source', 'aTargets': [ 5 ]},
            {
                'data': 'severity',
                'sName': 'Severity',
                'aTargets': [6],
                'render': function(data, type, row) {
                    if (!data) {
                        return '';
                    }
                    var severity = data.toLowerCase();
                    var label = data.charAt(0).toUpperCase() + data.slice(1);
                    var html = '<span class="severity-badge severity-' + severity + '">' + label + '</span>';
                    return type === 'display' ? html : data;
                }
            },
            {'data': 'scan_date', 'sName': 'Scan Date', 'aTargets': [ 7 ],
                'render': function(data, type, row) {
                if (!data) return '';
                // Use moment.js for formatting if available
                if (window.moment) {
                    return moment(data).format('DD-MM-YYYY HH:mm');
                }
                // Fallback: just show the string
                return data;
                }
            },
            {'data': 'last_reported', 'sName': 'Last reported', 'aTargets': [ 8 ],
                'render': function(data, type, row) {
                if (!data) return '';
                // Use moment.js for formatting if available
                if (window.moment) {
                    return moment(data).format('DD-MM-YYYY HH:mm');
                }
                // Fallback: just show the string
                return data;
                }
            },
            {'data': 'comment', 'sName': 'Comment', 'aTargets': [ 9 ]},
        ]
    });

    // Apply the search
    // Use the global debounced column search from base.html
    applyDebouncedColumnSearch(findingsTable, 'input.column-search', 'select.column-search');

    // Apply the severity filter (server-side)
    $('#severity-filter').on('change', function () {
        findingsTable.ajax.reload();
    });

    // Server-side reported filter
    $('#reported-filter').on('change', function () {
        findingsTable.ajax.reload();
    });
    // Server-side monitored filter
    $('#monitored-filter').on('change', function () {
        findingsTable.ajax.reload();
    });

    // Initialize all common DataTable features
    initializeCommonDataTableFeatures(findingsTable, {
        enableBulkIgnore: true,
        hasNucleus: true,
        hasCommentModal: true,
        projectId: "{{ projectid }}",
        selectAllId: '#select-all-findings',
        tableId: '#table_list_findings'
    });

});

</script>
{% endblock %}