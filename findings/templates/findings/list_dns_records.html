{% extends "base.html" %}
{% load static %}

{% block header %}
<style>
#table_list_dns_records tbody tr.selected td {
  background-color: #B0BED9
}

#table_list_dns_records tbody tr.odd.selected td {
  background-color: #acbad4
}
</style>
{% endblock %}

{% block content %}
{% spaceless %}
<div class="page-header">
  <div class="media">
    <div class="media-left">
    </div>
    <div class="media-body">
      <h2 class="media-heading">DNS Records</h2>DNS records for monitored assets only
    </div>
  </div>
</div>
{% if messages %}{% for message in messages %}<div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>{{ message }}</div>{% endfor %}{% endif %}

<!-- DNS Records List -->
<div class="panel panel-default">
  <div class="panel-heading">
    // DNS Records for Monitored Assets ({{ total_records }} total)
  </div>
  <div class="panel-body table-responsive">
    <table id="table_list_dns_records" class="table table-condensed table-striped table-bordered" style="font-size: 0.9em;">
      <thead>
        <tr>
          <th><input type="checkbox" name="select_all" value="1" id="select-all-dns-records">&nbsp; Operations</th>
          <th>Asset</th>
          <th>Record Type</th>
          <th>Record Value</th>
          <th>TTL</th>
          <th>Last Checked</th>
        </tr>
        <tr>
          <th></th>
          <th><input type="text" placeholder="Search Asset" class="column-search form-control input-sm"></th>
          <th>
            <select id="record-type-filter" class="form-control input-sm">
              <option value="">All Types</option>
              <option value="A">A</option>
              <option value="AAAA">AAAA</option>
              <option value="CNAME">CNAME</option>
              <option value="MX">MX</option>
              <option value="TXT">TXT</option>
              <option value="NS">NS</option>
              <option value="SOA">SOA</option>
              <option value="PTR">PTR</option>
            </select>
          </th>
          <th><input type="text" placeholder="Search Value" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search TTL" class="column-search form-control input-sm"></th>
          <th><input type="text" placeholder="Search Date" class="column-search form-control input-sm"></th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be loaded via AJAX -->
      </tbody>
    </table>
  </div>
</div>

{% endspaceless %}
{% endblock %}

{% block javascript %}
<script type="text/javascript" language="javascript" class="init">
$(document).ready(function() {
    // Function to initialize a DataTable with server-side processing
    function initializeDataTable(tableId, ajaxUrl) {
        return $(tableId).DataTable({
            processing: true,
            serverSide: true,
            pageLength: 25,
            orderCellsTop: true,
            oLanguage: { sProcessing: "<img src='{% static 'img/loading.gif' %}'>", },
            order: [[5, "desc"]], // Sort by last checked date
            ajax: {
                url: ajaxUrl,
                dataSrc: "results",
                type: "GET",
                dataType: "json"
            },
            columns: [
                {
                    'data': 'id', 'sName': 'Operations', 'aTargets': [0], 'bSortable': false,
                    "mRender": function (data, type, full) {
                        return '<input type="checkbox" name="id[]" value="' + data + '">';
                    }
                },
                {
                    'data': 'asset_value', 'sName': 'Asset', 'aTargets': [1],
                    "mRender": function (data, type, full) {
                        var asset_url = "{% url 'findings:view_asset' uuid='PLACEHOLDER' %}".replace('PLACEHOLDER', full.asset_uuid);
                        return '<a href="' + asset_url + '">' + data + '</a>';
                    }
                },
                {
                    'data': 'record_type', 'sName': 'Record Type', 'aTargets': [2],
                    "mRender": function (data, type, full) {
                        return '<span class="label label-info">' + data + '</span>';
                    }
                },
                {
                    'data': 'record_value', 'sName': 'Record Value', 'aTargets': [3],
                    "mRender": function (data, type, full) {
                        var truncated = data.length > 50 ? data.substring(0, 50) + '...' : data;
                        return '<span style="font-family: monospace; font-size: 12px;" rel="tooltip" data-placement="left" data-original-title="' + data + '">' + truncated + '</span>';
                    }
                },
                {
                    'data': 'ttl', 'sName': 'TTL', 'aTargets': [4],
                    "mRender": function (data, type, full) {
                        return data ? data + 's' : '-';
                    }
                },
                {
                    'data': 'last_checked', 'sName': 'Last Checked', 'aTargets': [5],
                    "mRender": function (data, type, full) {
                        if (!data) return '';
                        if (window.moment) {
                            if (typeof data === 'string' && data.endsWith('Z')) {
                                return moment.utc(data).local().format('DD-MM-YYYY HH:mm');
                            }
                            return moment(data).format('DD-MM-YYYY HH:mm');
                        }
                        return data;
                    }
                }
            ]
        });
    }

    // Initialize the DNS records table
    var dnsTable = initializeDataTable('#table_list_dns_records', "/api/v1/project/{{ projectid }}/dns_records/");

    // Column search functionality
    $('.column-search').on('keyup', function() {
        var column = dnsTable.column($(this).parent().index());
        column.search(this.value).draw();
    });

    // Record type filter
    $('#record-type-filter').on('change', function() {
        var column = dnsTable.column(2); // Record type column
        if (this.value) {
            column.search(this.value, false, false).draw();
        } else {
            column.search('').draw();
        }
    });

    // Select all functionality
    $('#select-all-dns-records').on('change', function() {
        var isChecked = $(this).prop('checked');
        dnsTable.$('input[name="id[]"]').prop('checked', isChecked);
    });

    // Individual checkbox change (using event delegation for dynamically loaded content)
    $(document).on('change', 'input[name="id[]"]', function() {
        var totalCheckboxes = dnsTable.$('input[name="id[]"]').length;
        var checkedCheckboxes = dnsTable.$('input[name="id[]"]:checked').length;
        $('#select-all-dns-records').prop('checked', totalCheckboxes === checkedCheckboxes);
    });

    // Initialize tooltips (using event delegation for dynamically loaded content)
    $(document).on('mouseenter', '[rel="tooltip"]', function() {
        $(this).tooltip();
    });
});
</script>
{% endblock %}
